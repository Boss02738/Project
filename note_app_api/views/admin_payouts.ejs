<!-- views/admin_purchases.ejs -->
<h3>Purchases (<%= status %>)</h3>

<style>
  table.purchases { width:100%; border-collapse:collapse; table-layout:fixed; }
  table.purchases th, table.purchases td {
    border-bottom:1px solid #1f2937; padding:10px 8px; text-align:left; vertical-align:middle;
  }
  table.purchases thead th { white-space:nowrap; }

  .col-id      { width:6%;  }
  .col-buyer   { width:14%; }
  .col-seller  { width:14%; }
  .col-post    { width:34%; }
  .col-amount  { width:9%;  }
  .col-slip    { width:9%;  }
  .col-created { width:14%; }
  .col-actions { width:10%; }

  .price { font-weight:600; }

  /* โพสต์ที่ซื้อ (ถ้ามีรูปปก) */
  td.post-cell { overflow:hidden; }
  .post-wrap { display:flex; gap:12px; align-items:flex-start; max-width:100%; }
  .post-meta { display:flex; flex-direction:column; gap:4px; min-width:220px; max-width:100%; }
  .post-title {
    font-weight:700; line-height:1.25;
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  }
  .post-text {
    opacity:.9; line-height:1.3;
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  }

  /* ปุ่ม/รูป */
  .img-btn { border:0; padding:0; background:transparent; line-height:0; cursor:zoom-in; }
  .thumb   { height:56px; border-radius:8px; border:1px solid #334155; display:block; }
  .post-thumb { width:84px; height:84px; object-fit:cover; }

  /* Lightbox (เหมือน payouts) */
  .img-modal { position:fixed; inset:0; background:rgba(0,0,0,.8); display:none;
               align-items:center; justify-content:center; z-index:9999; }
  .img-modal.open { display:flex; }
  .img-modal .wrap { max-width:92vw; max-height:92vh; position:relative; }
  .img-modal img  { max-width:92vw; max-height:92vh; border-radius:12px; display:block; background:#0b0b0b; }
  .img-modal .close{
    position:absolute; top:8px; right:8px; width:36px; height:36px; border-radius:999px;
    border:1px solid #334155; background:rgba(17,24,39,.95); color:#fff; cursor:pointer;
    display:flex; align-items:center; justify-content:center; font-size:18px; line-height:1;
  }

  @media (max-width: 640px){
    .post-thumb{ width:72px; height:72px; }
    .col-post{ width:auto; }
  }
</style>

<table class="purchases" role="grid">
  <colgroup>
    <col class="col-id" />
    <col class="col-buyer" />
    <col class="col-seller" />
    <col class="col-post" />
    <col class="col-amount" />
    <col class="col-slip" />
    <col class="col-created" />
    <col class="col-actions" />
  </colgroup>

  <thead>
    <tr>
      <th>ID</th><th>Buyer</th><th>Seller</th><th>Post</th>
      <th>Amount</th><th>Slip</th><th>Created</th><th>Actions</th>
    </tr>
  </thead>

  <tbody>
    <% if (!(rows||[]).length) { %>
      <tr><td colspan="8" style="text-align:center;opacity:.7">No items</td></tr>
    <% } %>

    <% rows.forEach(r => { %>
      <tr>
        <td>#<%= r.id %></td>
        <td><%= r.buyer_name %> (#<%= r.buyer_id %>)</td>
        <td><%= r.seller_name %> (#<%= r.seller_id %>)</td>

        <!-- Post (มีรูปปกก็คลิกดูได้) -->
        <td class="post-cell">
          <div class="post-wrap">
            <% if (r.post_cover) { %>
              <button type="button" class="img-btn" data-src="<%= r.post_cover %>" aria-label="Open post image">
                <img src="<%= r.post_cover %>" alt="post cover" class="thumb post-thumb" />
              </button>
            <% } %>
            <div class="post-meta">
              <% if (r.post_subject || r.post_year_label) { %>
                <div class="post-title">
                  <%= r.post_subject || '-' %>
                  <% if (r.post_year_label) { %><span style="opacity:.7"> · <%= r.post_year_label %></span><% } %>
                </div>
              <% } %>
              <div class="post-text">
                <%= ((r.post_text || r.post_excerpt || r.post || '—') + '').slice(0, 200) %>
              </div>
            </div>
          </div>
        </td>

        <td class="price">฿<%= ((r.amount_satang||0)/100).toFixed(2) %></td>

        <!-- Slip (ใช้ปุ่ม ไม่ใช้ <a>) -->
        <td>
          <% if (r.slip_path) { %>
            <button type="button" class="img-btn" data-src="<%= r.slip_path %>" aria-label="Open slip">
              <img class="thumb" src="<%= r.slip_path %>" alt="slip">
            </button>
          <% } else { %><em>no slip</em><% } %>
        </td>

        <td>
          <% const d = r.created_at ? new Date(r.created_at) : null; %>
          <% if (d) { %>
            <div><%= d.toLocaleDateString('th-TH') %></div>
            <div style="opacity:.85"><%= d.toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' }) %></div>
          <% } else { %>-<% } %>
        </td>

        <td>
          <form method="post" action="/admin/purchases/<%= r.id %>/approve" style="display:inline">
            <button type="submit">Approve</button>
          </form>
          <form method="post" action="/admin/purchases/<%= r.id %>/reject" style="display:inline">
            <button type="submit" class="secondary">Reject</button>
          </form>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>

<!-- Lightbox Modal -->
<div id="imgModal" class="img-modal" aria-hidden="true">
  <div class="wrap">
    <button class="close" type="button" aria-label="Close">×</button>
    <img id="imgModalImg" alt="preview">
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('imgModal');
    const imgEl  = document.getElementById('imgModalImg');
    const closeBtn = modal.querySelector('.close');

    function openModal(src){
      if(!src) return;
      imgEl.src = src;                            // โหลดรูปเข้า <img> (ไม่เปลี่ยนหน้า/ไม่ดาวน์โหลด)
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      imgEl.src = '';
    }

    // จับปุ่มรูปที่มี data-src (ทั้ง slip และ post cover)
    document.addEventListener('click', (e) => {
      const t = e.target.closest('[data-src]');
      if (!t) return;
      e.preventDefault();
      e.stopPropagation();
      openModal(t.dataset.src);
    });

    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    closeBtn.addEventListener('click', closeModal);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
  });
</script>
