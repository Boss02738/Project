<!-- views/admin_payouts.ejs -->
<h3>Payouts (<%= status %>)</h3>

<style>
  table.payouts { width:100%; border-collapse:collapse; table-layout:fixed; }
  table.payouts th, table.payouts td {
    border-bottom:1px solid #1f2937; padding:10px 8px; text-align:left; vertical-align:middle;
  }
  table.payouts thead th { white-space:nowrap; }

  /* คอลัมน์: ID, User, QR, Gross, Net, Requested, Action */
  .col-id        { width:7%;  }
  .col-user      { width:18%; }
  .col-qr        { width:16%; }
  .col-gross     { width:11%; }
  .col-net       { width:11%; }
  .col-requested { width:19%; }
  .col-action    { width:18%; }

  .qr-btn { border:0; padding:0; background:transparent; line-height:0; cursor:zoom-in; }
  .qr-thumb { height:56px; border-radius:8px; border:1px solid #334155; display:block; }

  /* Lightbox modal */
  .img-modal { position:fixed; inset:0; background:rgba(0,0,0,.8); display:none;
               align-items:center; justify-content:center; z-index:9999; }
  .img-modal.open { display:flex; }
  .img-modal .wrap { max-width:92vw; max-height:92vh; position:relative; }
  .img-modal img  { max-width:92vw; max-height:92vh; border-radius:12px; display:block; background:#0b0b0b; }
  .img-modal .close{
    position:absolute; top:8px; right:8px;
    width:36px; height:36px; border-radius:999px;
    border:1px solid #334155; background:rgba(17,24,39,.95);
    color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center;
    font-size:18px; line-height:1;
  }

  @media (max-width: 640px){
    .col-qr { width:22%; }
    .qr-thumb { height:48px; }
  }
</style>

<table class="payouts" role="grid">
  <colgroup>
    <col class="col-id" />
    <col class="col-user" />
    <col class="col-qr" />
    <col class="col-gross" />
    <col class="col-net" />
    <col class="col-requested" />
    <col class="col-action" />
  </colgroup>

  <thead>
    <tr>
      <th>ID</th>
      <th>User</th>
      <th>QR / PromptPay</th>
      <th>Gross</th>
      <th>Net</th>
      <th>Requested</th>
      <th>Action</th>
    </tr>
  </thead>

  <tbody>
    <% if ((rows || []).length === 0) { %>
      <tr><td colspan="7" style="text-align:center;opacity:.7">No items</td></tr>
    <% } %>

    <% rows.forEach(r => { %>
      <tr>
        <td>#<%= r.id %></td>

        <!-- ควร SELECT u.username AS username, w.user_id AS user_id -->
        <td><%= r.username %> (#<%= r.user_id %>)</td>

        <!-- แสดงไฟล์ QR ที่แนบ -->
        <td>
          <% if (r.bank_qr_file) { %>
            <button type="button" class="qr-btn" data-src="<%= r.bank_qr_file %>" aria-label="Open QR">
              <img src="<%= r.bank_qr_file %>" alt="QR" class="qr-thumb" />
            </button>
          <% } else { %>
            -
          <% } %>
        </td>

        <!-- amount_satang เป็นจำนวนสตางค์ -->
        <td>฿<%= ((r.amount_satang || 0) / 100).toFixed(2) %></td>

        <!-- ถ้าไม่มีระบบค่าธรรมเนียม Net = Gross -->
        <td>฿<%= ((r.amount_satang || 0) / 100).toFixed(2) %></td>

        <td>
          <% const d = r.created_at ? new Date(r.created_at) : null; %>
          <% if (d) { %>
            <div><%= d.toLocaleDateString('th-TH') %></div>
            <div style="opacity:.85"><%= d.toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' }) %></div>
          <% } else { %>-<% } %>
        </td>

        <td>
          <form method="post" action="/admin/payouts/<%= r.id %>/mark-paid" style="display:inline">
            <button type="submit">Mark paid</button>
          </form>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>

<!-- Image Modal -->
<div id="imgModal" class="img-modal" aria-hidden="true">
  <div class="wrap">
    <button class="close" type="button" aria-label="Close">×</button>
    <img id="imgModalImg" alt="preview">
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('imgModal');
    const imgEl  = document.getElementById('imgModalImg');
    const closeBtn = modal.querySelector('.close');

    const open = (src) => {
      if (!src) return;
      imgEl.src = src;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    };
    const close = () => {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      imgEl.src = '';
    };

    // เปิด modal จากปุ่มรูป QR
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.qr-btn');
      if (!btn) return;
      e.preventDefault();
      e.stopPropagation();
      open(btn.dataset.src);
    });

    // ปิด modal
    modal.addEventListener('click', (e) => { if (e.target === modal) close(); });
    closeBtn.addEventListener('click', close);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
  });
</script>
